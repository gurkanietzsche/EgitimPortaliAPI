@{
    ViewData["Title"] = "Kurslar";
}

<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0 text-gray-800">Tüm Kurslar</h1>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" class="form-control" id="searchCourse" placeholder="Kurs ara...">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        <i class="fas fa-search fa-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Kategoriler</h6>
                </div>
                <div class="card-body">
                    <div class="list-group" id="categoryList">
                        <a href="#" class="list-group-item list-group-item-action active" data-id="0">Tüm Kategoriler</a>
                        <!-- Kategoriler burada listelenecek -->
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Yükleniyor...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Fiyat Aralığı</h6>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="priceRange">Maksimum Fiyat: <span id="priceValue">1000 TL</span></label>
                        <input type="range" class="form-control-range" id="priceRange" min="0" max="1000" value="1000">
                    </div>
                    <button class="btn btn-primary btn-block" id="applyFilters">Filtrele</button>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="row" id="coursesList">
                <!-- Kurslar burada listelenecek -->
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Yükleniyor...</span>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Sayfalama burada oluşturulacak -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Değişkenler
            let selectedCategoryId = 0;
            let maxPrice = 1000;
            let currentPage = 1;
            let coursesPerPage = 6;
            let allCourses = [];

            // Slider değer gösterimi
            $("#priceRange").on("input", function() {
                maxPrice = $(this).val();
                $("#priceValue").text(maxPrice + " TL");
            });

            // Filtreleri uygula
            $("#applyFilters").click(function() {
                filterCourses();
            });

            // Kursları getir
            loadCourses();

            // Kategorileri getir
            loadCategories();

            // Arama işlemi
            $("#searchButton").click(function() {
                filterCourses();
            });

            $("#searchCourse").keypress(function(e) {
                if (e.which === 13) {
                    filterCourses();
                }
            });

            // Kursları getirme fonksiyonu
            function loadCourses() {
                $.ajax({
                    type: "GET",
                    url: "/Home/GetCourses",
                    success: function(response) {
                        if (response.success) {
                            allCourses = response.data;
                            filterCourses();
                        } else {
                            $("#coursesList").html("<div class='col-12 text-center'><p>Kurslar yüklenirken bir hata oluştu.</p></div>");
                        }
                    },
                    error: function() {
                        $("#coursesList").html("<div class='col-12 text-center'><p>Kurslar yüklenirken bir hata oluştu.</p></div>");
                    }
                });
            }

            // Kategorileri getirme fonksiyonu
            function loadCategories() {
                $.ajax({
                    type: "GET",
                    url: "/Home/GetCategories",
                    success: function(response) {
                        if (response.success) {
                            let categoriesHtml = '<a href="#" class="list-group-item list-group-item-action active" data-id="0">Tüm Kategoriler</a>';

                            response.data.forEach(category => {
                                categoriesHtml += `<a href="#" class="list-group-item list-group-item-action" data-id="${category.id}">${category.name}</a>`;
                            });

                            $("#categoryList").html(categoriesHtml);

                            // Kategori seçimi
                            $(".list-group-item").click(function(e) {
                                e.preventDefault();

                                $(".list-group-item").removeClass("active");
                                $(this).addClass("active");

                                selectedCategoryId = $(this).data("id");
                                filterCourses();
                            });
                        } else {
                            $("#categoryList").html("<div class='text-center'><p>Kategoriler yüklenirken bir hata oluştu.</p></div>");
                        }
                    },
                    error: function() {
                        $("#categoryList").html("<div class='text-center'><p>Kategoriler yüklenirken bir hata oluştu.</p></div>");
                    }
                });
            }

            // Kursları filtreleme fonksiyonu
            function filterCourses() {
                const searchText = $("#searchCourse").val().toLowerCase();

                // Filtreleme
                let filteredCourses = allCourses.filter(course => {
                    let matchesCategory = selectedCategoryId === 0 || course.categoryId === selectedCategoryId;
                    let matchesPrice = course.price <= maxPrice;
                    let matchesSearch = searchText === "" || course.title.toLowerCase().includes(searchText) || (course.description && course.description.toLowerCase().includes(searchText));

                    return matchesCategory && matchesPrice && matchesSearch;
                });

                // Toplam sayfa sayısını hesapla
                const totalPages = Math.ceil(filteredCourses.length / coursesPerPage);

                // Mevcut sayfanın kurslarını al
                const startIndex = (currentPage - 1) * coursesPerPage;
                const endIndex = startIndex + coursesPerPage;
                const currentCourses = filteredCourses.slice(startIndex, endIndex);

                // Kursları göster
                displayCourses(currentCourses);

                // Sayfalama oluştur
                createPagination(totalPages);

                // Eğer hiç kurs yoksa
                if (filteredCourses.length === 0) {
                    $("#coursesList").html("<div class='col-12 text-center'><p>Kriterlere uygun kurs bulunamadı.</p></div>");
                }
            }

            // Kursları gösterme fonksiyonu
            function displayCourses(courses) {
                let coursesHtml = "";

                courses.forEach(course => {
                    coursesHtml += `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <img src="${course.imageUrl || '/img/no-image.jpg'}" class="card-img-top" alt="${course.title}" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${course.title}</h5>
                                    <p class="card-text">${course.description ? (course.description.length > 100 ? course.description.substring(0, 100) + '...' : course.description) : ''}</p>
                                    <p class="font-weight-bold text-primary">${course.price} TL</p>
                                </div>
                                <div class="card-footer">
                                    <a href="/Home/CourseDetail/${course.id}" class="btn btn-primary btn-block">Detayları Gör</a>
                                </div>
                            </div>
                        </div>
                    `;
                });

                $("#coursesList").html(coursesHtml);
            }

            // Sayfalama oluşturma fonksiyonu
            function createPagination(totalPages) {
                let paginationHtml = "";

                // Önceki sayfa
                paginationHtml += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                `;

                // Sayfa numaraları
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }

                // Sonraki sayfa
                paginationHtml += `
                    <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                `;

                $("#pagination").html(paginationHtml);

                // Sayfa değiştirme olayı
                $(".page-link").click(function(e) {
                    e.preventDefault();

                    const page = $(this).data("page");

                    // Geçerli sayfa kontrolü
                    if (page < 1 || page > totalPages || page === currentPage) {
                        return;
                    }

                    currentPage = page;
                    filterCourses();
                });
            }
        });
    </script>
}